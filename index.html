<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-xl mx-auto p-6 space-y-6">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <header class="text-center">
      <h1 class="text-2xl font-bold">üßô‚Äç‚ôÄÔ∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–∫–∞–∑–æ—á–Ω–æ–π –º—É–¥—Ä–æ—Å—Ç–∏</h1>
      <p class="text-sm text-gray-600">–¶–∏—Ñ—Ä–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–º—ã—Å–ª–æ–≤ –∏ —á—É–¥–µ—Å</p>
    </header>

    <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-xl font-semibold mb-2">üë§ –ü—Ä–æ—Ñ–∏–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
      <p><strong>–ò–º—è:</strong> <span id="username">‚Äì</span></p>
      <p><strong>–°–∫–∞–∑–æ—á–Ω–∞—è –º—É–¥—Ä–æ—Å—Ç—å:</strong> <span id="points" class="text-green-600 font-bold">‚Ä¶</span></p>
    </section>

    <!-- –ö–æ–º–∞–Ω–¥–∞ -->
    <section id="team-box" class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-xl font-semibold mb-2">üèÜ –ö–æ–º–∞–Ω–¥–∞: <span id="team-name">‚Äì</span></h2>
      <p><strong>–°–∫–∞–∑–æ—á–Ω–∞—è –º—É–¥—Ä–æ—Å—Ç—å:</strong> <span id="team-points" class="text-blue-600 font-bold">‚Äì</span></p>
    </section>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="message-area" class="hidden p-4 text-sm font-bold text-center rounded-lg"></div>

    <!-- –ó–∞–¥–∞–Ω–∏—è -->
    <div id="tasks-container" class="space-y-4"></div>

    <!-- –ê—É–∫—Ü–∏–æ–Ω -->
    <section class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-xl font-semibold mb-2">üí∞ –ú–∞–≥–∞–∑–∏–Ω –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (–ê—É–∫—Ü–∏–æ–Ω)</h2>
      <div id="lots-display" class="grid gap-4 grid-cols-1 sm:grid-cols-2">
        <p id="loading-lots-text" class="text-gray-500 col-span-full">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ—Ç–æ–≤...</p>
      </div>
    </section>

    <!-- –§—É—Ç–µ—Ä -->
    <footer class="text-center text-xs text-gray-500 mt-6">–ë–æ–ª—å—à–∞—è –ø–µ—Ä–µ–º–µ–Ω–∞ ¬© 2025</footer>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    const user = tg.initDataUnsafe.user;
    const userId = user?.id;
    const username = user?.username || user?.first_name || "–ë–µ–∑ –∏–º–µ–Ω–∏";
    const keyword = tg.initDataUnsafe.start_param;
    const PROXY_API_URL = 'https://telegram-gamification-proxy-git-main-mashuks-projects-27504670.vercel.app';

    // UI —ç–ª–µ–º–µ–Ω—Ç—ã
    const pointsDisplay = document.getElementById('points');
    const teamNameDisplay = document.getElementById('team-name');
    const teamPointsDisplay = document.getElementById('team-points');
    const lotsDisplay = document.getElementById('lots-display');
    const loadingLotsText = document.getElementById('loading-lots-text');
    const messageArea = document.getElementById('message-area');
    const tasksContainer = document.getElementById('tasks-container');
    document.getElementById('username').textContent = username;

    async function sendPost(endpoint, payload) {
      try {
        const res = await fetch(`${PROXY_API_URL}/api/${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text());
        return await res.json();
      } catch (err) {
        showMessage(`–û—à–∏–±–∫–∞: ${err.message}`, 'error');
        return { error: err.message };
      }
    }

    function showMessage(msg, type) {
      const colors = {
        success: 'bg-green-100 text-green-800',
        error: 'bg-red-100 text-red-800',
        info: 'bg-blue-100 text-blue-800'
      };
      messageArea.textContent = msg;
      messageArea.className = `block p-4 rounded-lg font-bold text-center ${colors[type] || ''}`;
      if (!msg) messageArea.classList.add('hidden');
      if (type !== 'info') setTimeout(() => messageArea.classList.add('hidden'), 5000);
    }

    async function loadUserData() {
      lotsDisplay.innerHTML = '<p class="text-gray-500 col-span-full">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ—Ç–æ–≤...</p>';
      const res = await sendPost('submit_user', { user_id: userId, username });

      if (!res.error) {
        pointsDisplay.textContent = `${res.points ?? 0} üß†`;
        teamNameDisplay.textContent = res.team || '‚Äì';
        teamPointsDisplay.textContent = `${res.team_points ?? '‚Äì'} üß†`;
        displayLots(res.bonuses || [], res.points ?? 0);
      } else {
        lotsDisplay.innerHTML = '<p class="text-gray-500 col-span-full">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ—Ç–æ–≤</p>';
      }
    }

    function displayLots(lots, userPoints) {
      lotsDisplay.innerHTML = '';
      if (!lots.length) {
        lotsDisplay.innerHTML = '<p class="text-gray-500 col-span-full">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤</p>';
        return;
      }

      lots.forEach(lot => {
        const available = userPoints >= lot.cost;
        const card = document.createElement('div');
        card.className = 'bg-gray-50 p-4 rounded-xl shadow flex flex-col';
        card.innerHTML = `
          ${lot.image_url ? `<img src="${lot.image_url}" class="mb-3 h-40 w-full object-cover rounded-md">` : ''}
          <h3 class="text-lg font-bold mb-1">${lot.title}</h3>
          <p class="text-sm text-gray-700 mb-2 flex-grow">${lot.description}</p>
          <p class="font-semibold text-gray-800 mb-2">–°—Ç–æ–∏–º–æ—Å—Ç—å: <span class="text-yellow-600">${lot.cost} üß†</span></p>
          <p class="text-xs ${available ? 'text-green-600' : 'text-red-500'} mb-2">${available ? '–î–æ—Å—Ç—É–ø–µ–Ω' : `–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω—É–∂–Ω–æ ${lot.missing_points} üß†)`}</p>
          <button class="mt-auto bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 disabled:opacity-50" ${available ? '' : 'disabled'} data-lot="${lot.title}">–ö—É–ø–∏—Ç—å</button>
        `;
        card.querySelector('button').addEventListener('click', () => buyLot(lot.title));
        lotsDisplay.appendChild(card);
      });
    }

    async function buyLot(lotName) {
      if (!confirm(`–ö—É–ø–∏—Ç—å "${lotName}" –∑–∞ –º—É–¥—Ä–æ—Å—Ç—å?`)) return;
      showMessage('–ü–æ–∫—É–ø–∫–∞...', 'info');
      const res = await sendPost('buy_lot', { user_id: userId, username, lot_name: lotName });
      showMessage(res.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∫—É–ø–∏—Ç—å', res.status === 'success' ? 'success' : 'error');
      if (res.status === 'success') loadUserData();
    }

    async function loadTasks() {
      try {
        const res = await fetch(`${PROXY_API_URL}/api/load_tasks`);
        const tasks = await res.json();
        tasksContainer.innerHTML = '';

        if (!tasks.length) {
          tasksContainer.innerHTML = '<p class="text-gray-500">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</p>';
          return;
        }

        tasks.forEach(task => {
          const block = document.createElement('div');
          block.className = 'bg-white rounded-2xl shadow p-4';
          block.innerHTML = `
            <h2 class="text-xl font-semibold mb-2">ü§© ${task.title}</h2>
            <p class="text-sm mb-2 text-gray-700">${task.description}</p>
            <form class="space-y-2">
              <input type="url" name="url" required placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç–≤–µ—Ç" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" />
              <button type="submit" class="w-full bg-purple-500 text-white py-2 rounded hover:bg-purple-600 text-sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
          `;
          block.querySelector('form').addEventListener('submit', async e => {
            e.preventDefault();
            const url = e.target.url.value.trim();
            if (!url) return;
            const res = await sendPost('submit_task_response', { user_id: userId, username, url, task: task.title });
            showMessage(res.error ? '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ' : '–°–ø–∞—Å–∏–±–æ! –ú—É–¥—Ä–æ—Å—Ç—å –ø–æ–ª—É—á–µ–Ω–∞.', res.error ? 'error' : 'success');
            if (!res.error) loadUserData();
            e.target.reset();
          });
          tasksContainer.appendChild(block);
        });
      } catch (e) {
        showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π.', 'error');
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      if (keyword) {
        const res = await sendPost('submit_keyword', { user_id: userId, username, keyword });
        if (res.status === 'added') {
          showMessage(`–ú—É–¥—Ä–æ—Å—Ç—å –∑–∞ –∫–ª—é—á "${keyword}" –ø–æ–ª—É—á–µ–Ω–∞!`, 'success');
        } else if (res.status === 'already_scanned') {
          showMessage(`–ö–ª—é—á "${keyword}" —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω.`, 'info');
        } else {
          showMessage(`–ö–ª—é—á "${keyword}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`, 'error');
        }
      }
      await loadUserData();
      await loadTasks();
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-xl mx-auto p-6">
    <div class="text-center mb-6">
      <h1 class="text-2xl font-bold">üßô‚Äç‚ôÄÔ∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–∫–∞–∑–æ—á–Ω–æ–π –º—É–¥—Ä–æ—Å—Ç–∏</h1>
      <p class="text-sm text-gray-600">–¶–∏—Ñ—Ä–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–º—ã—Å–ª–æ–≤ –∏ —á—É–¥–µ—Å</p>
    </div>

    <div class="bg-white rounded-2xl shadow p-4 mb-4">
      <h2 class="text-xl font-semibold mb-2">üë§ –ü—Ä–æ—Ñ–∏–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
      <p><strong>–ò–º—è:</strong> <span id="username">‚Äì</span></p>
      <p><strong>–ú—É–¥—Ä–æ—Å—Ç—å:</strong> <span id="points" class="text-green-600 font-bold">‚Ä¶</span></p>
    </div>

    <div class="bg-white rounded-2xl shadow p-4 mb-4">
      <h2 class="text-xl font-semibold mb-2">üéÆ –ü–æ–ª—É—á–∏—Ç—å –º—É–¥—Ä–æ—Å—Ç—å –∑–∞ –≤–∏–¥–µ–æ "–ê—Ä—Ö–µ—Ç–∏–ø –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞"</h2>
      <form id="video-form" class="space-y-2">
        <input id="video-link" type="url" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ"
          class="w-full border border-gray-300 rounded px-3 py-2 text-sm" required />
        <button type="submit"
          class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 text-sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    </div>

    <div class="bg-white rounded-2xl shadow p-4 mb-4">
      <h2 class="text-xl font-semibold mb-2">üé≠ –ü–æ–ª—É—á–∏—Ç—å –º—É–¥—Ä–æ—Å—Ç—å –∑–∞ —Ç–µ–∞—Ç—Ä–∞–ª—å–Ω—ã–π –ø–µ—Ä—Ñ–æ–º–∞–Ω—Å</h2>
      <form id="performance-form" class="space-y-2">
        <input id="performance-text" type="text" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à –ø–µ—Ä—Ñ–æ–º–∞–Ω—Å"
          class="w-full border border-gray-300 rounded px-3 py-2 text-sm" required />
        <button type="submit"
          class="w-full bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 text-sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    </div>

    <div id="tasks-container" class="space-y-4 mb-4"></div>

    <div class="bg-white rounded-2xl shadow p-4 mt-4">
        <h2 class="text-xl font-semibold mb-2">üìú –ò—Å—Ç–æ—Ä–∏—è –º—É–¥—Ä–æ—Å—Ç–µ–π</h2>
        <ul id="history-list" class="text-sm space-y-2">
          <li>–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</li>
        </ul>
      </div>

    <div class="bg-white rounded-2xl shadow p-4 mt-4">
      <h2 class="text-xl font-semibold mb-2">ü™Ñ –î–æ—Å—Ç—É–ø –∫ –∞—É–∫—Ü–∏–æ–Ω—É</h2>
      <ul id="bonuses-list" class="text-sm space-y-2">
        <li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>
      </ul>
    </div>

    <div class="text-center text-xs text-gray-500 mt-6">
      –ë–æ–ª—å—à–∞—è –ø–µ—Ä–µ–º–µ–Ω–∞ ¬© 2025
    </div>
  </div>

  <script>
  const tg = window.Telegram.WebApp;
  tg.ready();

  const user = tg.initDataUnsafe.user;
  const userId = user?.id;
  const username = user?.username || user?.first_name || "–ë–µ–∑ –∏–º–µ–Ω–∏";
  const keyword = tg.initDataUnsafe.start_param;

  document.getElementById('username').textContent = username;

  const API = 'https://telegram-gamification-proxy-git-main-mashuks-projects-27504670.vercel.app';

  // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  function loadUserData() {
    fetch(`${API}/api/submit_user`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, username })
    })
    .then(res => res.json())
    .then(data => {
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤
      document.getElementById('points').textContent = `${data.points ?? 0} üß†`;

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç —Å –≥–∞–ª–æ—á–∫–∞–º–∏)
      const historyList = document.getElementById('history-list');
      historyList.innerHTML = '';
      
      if (!data.history || data.history.length === 0) {
        historyList.innerHTML = '<li class="text-gray-500">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</li>';
      } else {
        data.history.forEach(entry => {
          const li = document.createElement('li');
          li.className = 'flex items-center';
          
          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ entry —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ date)
          const eventDate = entry.date ? new Date(entry.date) : new Date();
          const formattedDate = `
            ${eventDate.getDate().toString().padStart(2, '0')}.
            ${(eventDate.getMonth()+1).toString().padStart(2, '0')}.
            ${eventDate.getFullYear()} 
            ${eventDate.getHours().toString().padStart(2, '0')}:
            ${eventDate.getMinutes().toString().padStart(2, '0')}
          `;
          
          li.innerHTML = `
            <span class="text-green-500 mr-2">‚úÖ</span>
            <span class="text-gray-700">${formattedDate}</span>
          `;
          historyList.appendChild(li);
        });
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –±–æ–Ω—É—Å—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ)
      const bonusesList = document.getElementById('bonuses-list');
      bonusesList.innerHTML = '';
      (data.bonuses || []).forEach(bonus => {
        const li = document.createElement('li');
        li.innerHTML = `üìé <strong>${bonus['–¢–∏–ø –±–æ–Ω—É—Å–∞']}</strong><br><span class="text-gray-700">${bonus['–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –±–æ–Ω—É—Å–∞']}</span><br><em>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${bonus['–ú–∏–Ω–∏–º—É–º –±–∞–ª–ª–æ–≤']} üß†</em>`;
        bonusesList.appendChild(li);
      });
    })
    .catch(error => {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    });
  }

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
  if (keyword) {
    fetch(`${API}/api/submit_keyword`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, keyword })
    });
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –≤–∏–¥–µ–æ
  document.getElementById('video-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const link = document.getElementById('video-link').value.trim();
    if (!link) return;

    fetch(`${API}/api/submit_video`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, username, url: link })
    })
    .then(() => {
      // –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
      loadUserData();
      document.getElementById('video-link').value = ''; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ
    });
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø–µ—Ä—Ñ–æ–º–∞–Ω—Å–∞
  document.getElementById('performance-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const text = document.getElementById('performance-text').value.trim();
    if (!text) return;

    fetch(`${API}/api/submit_performance`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, username, text })
    })
    .then(() => {
      loadUserData();
      document.getElementById('performance-text').value = '';
    });
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á
  fetch(`${API}/api/load_tasks`)
    .then(res => res.json())
    .then(tasks => {
      const container = document.getElementById('tasks-container');
      container.innerHTML = '';

      (tasks || []).forEach(task => {
        const block = document.createElement('div');
        block.className = 'bg-white rounded-2xl shadow p-4';

        block.innerHTML = `
          <h2 class="text-xl font-semibold mb-2">ü§© ${task.title}</h2>
          <p class="text-sm mb-2 text-gray-700">${task.description}</p>
          <form class="space-y-2 task-form">
            <input type="url" name="url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç–≤–µ—Ç" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" required />
            <button type="submit" class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 text-sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </form>
        `;

        block.querySelector('form').addEventListener('submit', (e) => {
          e.preventDefault();
          const url = e.target.url.value.trim();
          if (!url) return;

          fetch(`${API}/api/submit_task_response`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, username, url, task: task.title })
          })
          .then(() => {
            loadUserData();
            e.target.url.value = '';
          });
        });

        container.appendChild(block);
      });
    });

  // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  loadUserData();
</script>
</body>
</html>

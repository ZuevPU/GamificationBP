<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-xl mx-auto p-6">
    <!-- –®–∞–ø–∫–∞ -->
    <div class="text-center mb-6">
      <h1 class="text-2xl font-bold">üéì –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞</h1>
      <p class="text-sm text-gray-600">–°–∏—Å—Ç–µ–º–∞ –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ–±—É—á–µ–Ω–∏—è</p>
    </div>

    <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
    <div class="bg-white rounded-2xl shadow p-4 mb-4">
      <h2 class="text-xl font-semibold mb-2">üë§ –ü—Ä–æ—Ñ–∏–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
      <p><strong>–ò–º—è:</strong> <span id="username">‚Äì</span></p>
      <p><strong>–ë–∞–ª–ª—ã:</strong> <span id="points" class="text-green-600 font-bold">‚Ä¶</span></p>
      <div class="mt-3">
        <label class="block text-sm text-gray-700 mb-1">–ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ –Ω–∞–≥—Ä–∞–¥—ã:</label>
        <div class="w-full bg-gray-200 rounded-full h-3">
          <div id="progress-bar" class="bg-green-500 h-3 rounded-full" style="width: 0%"></div>
        </div>
        <p id="progress-text" class="text-xs text-right text-gray-600">‚Ä¶</p>
      </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="bg-white rounded-2xl shadow p-4 mb-4">
      <h2 class="text-xl font-semibold mb-2">üìú –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–ª–æ–≤</h2>
      <ul id="history-list" class="text-sm list-disc pl-4">
        <li>–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</li>
      </ul>
    </div>

    <!-- –í–≤–æ–¥ –∫–æ–¥–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞ -->
    <div class="bg-white rounded-2xl shadow p-4 mb-4">
      <h2 class="text-xl font-semibold mb-2">üîë –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ</h2>
      <form id="keyword-form" class="flex gap-2">
        <input id="keyword-input" type="text" placeholder="#–∑–Ω–∞–Ω–∏–µ—Å–∏–ª–∞" class="flex-grow border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none" />
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    </div>

    <!-- –î–æ—Å—Ç—É–ø–Ω—ã–µ –±–æ–Ω—É—Å—ã -->
    <div class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-xl font-semibold mb-2">üéÅ –î–æ—Å—Ç—É–ø–Ω—ã–µ –±–æ–Ω—É—Å—ã</h2>
      <ul id="bonuses-list" class="text-sm space-y-2">
        <li>–ó–∞–≥—Ä—É–∑–∫–∞ –±–æ–Ω—É—Å–æ–≤...</li>
      </ul>
    </div>

    <!-- –§—É—Ç–µ—Ä -->
    <div class="text-center text-xs text-gray-500 mt-6">
      –ë–æ–ª—å—à–∞—è –ø–µ—Ä–µ–º–µ–Ω–∞ ¬© 2025
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    const user = tg.initDataUnsafe.user;

    const userId = user.id;
    const username = user.username || user.first_name;

    document.getElementById('username').textContent = username;
fetch('https://telegram-gamification-proxy.vercel.app/api/submit_user', {
  method: 'POST',
  mode: 'no-cors', // ‚Üê –≤–∞–∂–Ω–æ!
  headers: {
    'Content-Type': 'text/plain' // ‚Üê —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª preflight-–∑–∞–ø—Ä–æ—Å
  },
  body: JSON.stringify({ user_id: userId, username: username })
})
      .then(res => res.json())
      .then(data => {
        document.getElementById('points').textContent = `${data.points} üíé`;
        document.getElementById('progress-bar').style.width = `${Math.min((data.points / 20) * 100, 100)}%`;
        document.getElementById('progress-text').textContent = `${data.points} / 20`;

        const historyList = document.getElementById('history-list');
        historyList.innerHTML = '';
        (data.history || []).forEach(entry => {
          const li = document.createElement('li');
          li.textContent = `${entry}`;
          historyList.appendChild(li);
        });

        const bonusesList = document.getElementById('bonuses-list');
        bonusesList.innerHTML = '';
        data.bonuses.forEach(bonus => {
          const li = document.createElement('li');
          if (bonus.–î–æ—Å—Ç—É–ø–µ–Ω === '–¥–∞') {
            li.innerHTML = `‚ú® <a href="${bonus['–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –±–æ–Ω—É—Å–∞']}" class="text-blue-600 underline" target="_blank">${bonus['–¢–∏–ø –±–æ–Ω—É—Å–∞']}</a>`;
          } else {
            li.innerHTML = `üîí ${bonus['–¢–∏–ø –±–æ–Ω—É—Å–∞']} (–Ω—É–∂–Ω–æ –µ—â—ë ${bonus.–ù–µ–¥–æ—Å—Ç–∞–µ—Ç} –±–∞–ª–ª–æ–≤)`;
          }
          bonusesList.appendChild(li);
        });
      });

    document.getElementById('keyword-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const keyword = document.getElementById('keyword-input').value.trim();
      if (!keyword) return;

      fetch('/api/submit_keyword', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId, keyword })
      })
      .then(res => res.json())
      .then(result => {
        alert(result.message);
        location.reload();
      });
    });
  </script>
</body>
</html>
